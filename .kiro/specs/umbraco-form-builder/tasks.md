# План реализации: Конструктор форм для Umbraco CMS

## Обзор

Реализация конструктора форм будет выполнена поэтапно, начиная с базовой инфраструктуры (DTOs, entities, repositories), затем бизнес-логики (services), контроллеров и представлений, и заканчивая интеграцией и тестированием. Каждый этап включает реализацию функциональности и соответствующие тесты.

## Задачи

- [x] 1. Настройка Document Types в Umbraco
  - Создать Document Type `formField` с свойствами: fieldLabel, fieldType, fieldPlaceholder, isRequired, validationPattern, errorMessage
  - Создать Document Type `formBuilderBlock` с вкладками "Form Settings" и "Email Settings"
  - Настроить Block List для formFields
  - _Требования: 1.1, 2.1, 2.2_

- [ ] 2. Создание слоя данных (Domain и Infrastructure)
  - [x] 2.1 Создать entity FormSubmission
    - Создать класс `TestUmbraco.Domain/Entities/FormSubmission.cs` со свойствами: Id, FormId, FormTitle, SubmittedAt, IpAddress, FieldValuesJson, CreatedAt
    - _Требования: 8.1, 8.2_
  
  - [x] 2.2 Создать интерфейс IFormSubmissionRepository
    - Создать `TestUmbraco.Domain/Repositories/IFormSubmissionRepository.cs` с методами: SaveAsync, GetByIdAsync, GetByFormIdAsync, GetAllAsync
    - _Требования: 8.3_
  
  - [x] 2.3 Создать миграцию базы данных
    - Создать таблицу FormSubmissions с индексами на FormId и SubmittedAt
    - _Требования: 8.2_
  
  - [x] 2.4 Реализовать FormSubmissionRepository
    - Создать `TestUmbraco.Infrastructure/Repositories/FormSubmissionRepository.cs` с использованием IUmbracoDatabase
    - Реализовать все методы интерфейса
    - _Требования: 8.3, 8.4_
  
  - [ ]* 2.5 Написать property-тест для сохранения в БД
    - **Свойство 12: Сохранение отправки в базу данных**
    - **Валидирует: Требования 8.1, 8.2, 8.4**

- [ ] 3. Создание DTOs (Application Layer)
  - [x] 3.1 Создать FormFieldDto
    - Создать `TestUmbraco.Application/DTOs/FormFieldDto.cs` со свойствами: Label, Type, Placeholder, IsRequired, ValidationPattern, ErrorMessage, Name, Value
    - _Требования: 11.1_
  
  - [x] 3.2 Создать FormSubmissionDto
    - Создать `TestUmbraco.Application/DTOs/FormSubmissionDto.cs` со свойствами: FormId, FormTitle, SubmittedAt, IpAddress, FieldValues
    - _Требования: 11.1, 11.2_
  
  - [x] 3.3 Создать FormSubmissionModel
    - Создать `TestUmbraco/Models/FormSubmissionModel.cs` для привязки данных формы
    - _Требования: 12.1_
  
  - [ ]* 3.4 Написать property-тест для FieldValues
    - **Свойство 16: FieldValues использует fieldLabel как ключ**
    - **Валидирует: Требования 11.3**
  
  - [ ]* 3.5 Написать property-тест для сохранности данных DTO
    - **Свойство 17: Сохранность данных DTO при передаче**
    - **Валидирует: Требования 11.4**

- [ ] 4. Checkpoint - Проверка базовой инфраструктуры
  - Убедиться, что все тесты проходят, спросить пользователя если возникли вопросы

- [ ] 5. Расширение IEmailService
  - [x] 5.1 Добавить метод SendFormSubmissionAsync в IEmailService
    - Расширить `TestUmbraco.Application/Services/IEmailService.cs` новым методом
    - _Требования: 10.1_
  
  - [x] 5.2 Реализовать SendFormSubmissionAsync в EmailService
    - Добавить метод в `TestUmbraco.Application/Services/EmailService.cs`
    - Реализовать BuildFormSubmissionHtml для форматирования данных в HTML
    - Использовать существующую конфигурацию MailKit
    - _Требования: 10.2, 10.3, 10.4, 10.5_
  
  - [ ]* 5.3 Написать property-тест для включения всех полей в email
    - **Свойство 10: Все поля включены в email**
    - **Валидирует: Требования 7.5, 7.6, 10.3, 10.4**
  
  - [ ]* 5.4 Написать property-тест для корректности адреса и темы
    - **Свойство 11: Email отправляется на правильный адрес с правильной темой**
    - **Валидирует: Требования 7.3, 7.4**
  
  - [ ]* 5.5 Написать unit-тест для BuildFormSubmissionHtml
    - Проверить корректность форматирования HTML
    - Проверить наличие всех обязательных элементов (заголовок, дата, IP, таблица полей)
    - _Требования: 10.3, 10.4_

- [ ] 6. Создание FormSubmissionService
  - [x] 6.1 Создать интерфейс IFormSubmissionService
    - Создать `TestUmbraco.Application/Services/IFormSubmissionService.cs` с методами: ProcessSubmissionAsync, GetSubmissionsByFormAsync
    - _Требования: 8.3_
  
  - [x] 6.2 Реализовать FormSubmissionService
    - Создать `TestUmbraco.Application/Services/FormSubmissionService.cs`
    - Реализовать ProcessSubmissionAsync с обработкой ошибок и логированием
    - Реализовать GetSubmissionsByFormAsync
    - _Требования: 8.1, 8.2, 8.3, 8.4, 8.5_
  
  - [ ]* 6.3 Написать property-тест для обработки ошибок БД
    - **Свойство 13: Обработка продолжается при ошибке БД**
    - **Валидирует: Требования 8.5**
  
  - [ ]* 6.4 Написать unit-тест для ProcessSubmissionAsync
    - Проверить успешное сохранение
    - Проверить обработку ошибок с логированием
    - _Требования: 8.1, 8.2, 8.4, 8.5_

- [ ] 7. Создание FormBuilderController
  - [x] 7.1 Создать FormBuilderController (SurfaceController)
    - Создать `TestUmbraco/Controllers/FormBuilderController.cs`
    - Настроить dependency injection для IEmailService, IFormSubmissionService, IReCaptchaService
    - _Требования: 12.1, 12.2_
  
  - [x] 7.2 Реализовать метод SubmitForm
    - Реализовать проверку reCAPTCHA
    - Реализовать server-side валидацию
    - Реализовать создание FormSubmissionDto
    - Реализовать вызов сервисов (сохранение в БД, отправка email)
    - Реализовать возврат результата (редирект или JSON)
    - _Требования: 5.1, 5.2, 5.3, 5.4, 5.5, 6.3, 6.4, 6.5, 7.1, 7.2, 7.3, 8.1, 9.1, 9.2, 12.3, 12.4, 12.5_
  
  - [ ]* 7.3 Написать property-тест для проверки reCAPTCHA
    - **Свойство 8: Проверка reCAPTCHA обязательна**
    - **Валидирует: Требования 6.3, 6.4, 6.5**
  
  - [ ]* 7.4 Написать property-тест для server-side валидации обязательных полей
    - **Свойство 4: Валидация обязательных полей (серверная часть)**
    - **Валидирует: Требования 5.1**
  
  - [ ]* 7.5 Написать property-тест для server-side валидации по паттерну
    - **Свойство 5: Валидация по регулярному выражению (серверная часть)**
    - **Валидирует: Требования 5.2, 14.2**
  
  - [ ]* 7.6 Написать property-тест для создания DTO
    - **Свойство 9: Создание DTO при валидной отправке**
    - **Валидирует: Требования 7.1, 11.2**
  
  - [ ]* 7.7 Написать property-тест для уведомлений об успехе
    - **Свойство 14: Уведомление об успешной отправке**
    - **Валидирует: Требования 9.1, 9.2**
  
  - [ ]* 7.8 Написать property-тест для уведомлений об ошибках
    - **Свойство 15: Уведомление об ошибках**
    - **Валидирует: Требования 9.3, 9.6**
  
  - [ ]* 7.9 Написать integration-тест для полного цикла отправки
    - Проверить успешную отправку с валидными данными
    - Проверить вызовы всех сервисов
    - _Требования: 5.5, 6.5, 7.7, 8.4, 9.1_

- [ ] 8. Checkpoint - Проверка бэкенд логики
  - Убедиться, что все тесты проходят, спросить пользователя если возникли вопросы

- [ ] 9. Создание представления FormBuilderBlock.cshtml
  - [x] 9.1 Создать базовую структуру представления
    - Создать `TestUmbraco/Views/Partials/FormBuilderBlock.cshtml`
    - Реализовать рендеринг formTitle и formDescription
    - Создать форму с anti-forgery token и hidden полями
    - _Требования: 3.1, 3.2_
  
  - [x] 9.2 Реализовать рендеринг полей формы
    - Реализовать цикл по formFields
    - Реализовать switch для разных типов полей (text, email, phone, textarea, checkbox, radio, select)
    - Добавить data-атрибуты для валидации (data-required, data-pattern, data-error)
    - _Требования: 3.3, 3.4, 3.5, 3.6, 3.7, 3.8, 3.9, 3.10, 3.11, 3.12, 3.13, 13.1-13.8_
  
  - [x] 9.3 Добавить reCAPTCHA виджет и кнопку отправки
    - Добавить invisible reCAPTCHA виджет
    - Добавить кнопку отправки с текстом из submitButtonText
    - Добавить подключение скриптов (reCAPTCHA API, form-builder.js)
    - _Требования: 3.14, 6.1_
  
  - [ ]* 9.4 Написать unit-тест для рендеринга заголовка и описания
    - Проверить наличие formTitle в HTML
    - Проверить наличие formDescription в HTML
    - _Требования: 3.1, 3.2_
  
  - [ ]* 9.5 Написать property-тест для количества полей
    - **Свойство 3: Количество полей соответствует конфигурации**
    - **Валидирует: Требования 3.3**
  
  - [ ]* 9.6 Написать property-тест для соответствия типов полей
    - **Свойство 1: Соответствие типа поля и HTML элемента**
    - **Валидирует: Требования 3.4-3.10, 13.1-13.8**
  
  - [ ]* 9.7 Написать property-тест для атрибутов полей
    - **Свойство 2: Корректность атрибутов полей формы**
    - **Валидирует: Требования 3.11, 3.12, 3.13**

- [ ] 10. Создание client-side JavaScript (form-builder.js)
  - [x] 10.1 Создать базовую структуру и инициализацию
    - Создать `TestUmbraco/wwwroot/js/form-builder.js`
    - Реализовать initializeForm для каждой формы на странице
    - Добавить обработчик submit события
    - _Требования: 4.1_
  
  - [x] 10.2 Реализовать client-side валидацию
    - Реализовать validateForm для проверки всех полей
    - Реализовать validateField для проверки отдельного поля
    - Реализовать проверку обязательных полей
    - Реализовать проверку по validationPattern
    - Реализовать проверку email и phone
    - _Требования: 4.1, 4.2, 4.3, 4.4, 14.1, 14.3_
  
  - [x] 10.3 Реализовать отображение ошибок
    - Реализовать showFieldError для показа ошибки под полем
    - Реализовать clearFieldError для очистки ошибки
    - Добавить real-time валидацию на события blur и input
    - _Требования: 4.1, 4.2, 4.3, 4.4_
  
  - [x] 10.4 Реализовать интеграцию с reCAPTCHA
    - Реализовать getReCaptchaToken для получения токена
    - Добавить токен в форму перед отправкой
    - _Требования: 6.2_
  
  - [x] 10.5 Реализовать AJAX отправку формы
    - Реализовать submitForm с использованием fetch API
    - Реализовать обработку ответа (success/error)
    - Реализовать редирект или показ Toast notification
    - Реализовать блокировку кнопки во время отправки
    - _Требования: 9.1, 9.2, 9.3, 9.4, 9.5, 9.6_
  
  - [ ]* 10.6 Написать unit-тест для validateField
    - Проверить валидацию пустого обязательного поля
    - Проверить валидацию по паттерну
    - Проверить валидацию email
    - Проверить валидацию телефона
    - _Требования: 4.1, 4.2, 4.3, 4.4_
  
  - [ ]* 10.7 Написать property-тест для client-side валидации обязательных полей
    - **Свойство 4: Валидация обязательных полей (клиентская часть)**
    - **Валидирует: Требования 4.1**
  
  - [ ]* 10.8 Написать property-тест для client-side валидации по паттерну
    - **Свойство 5: Валидация по регулярному выражению (клиентская часть)**
    - **Валидирует: Требования 4.2, 14.1, 14.3**
  
  - [ ]* 10.9 Написать property-тест для валидации типов полей
    - **Свойство 6: Валидация типов полей**
    - **Валидирует: Требования 4.3, 4.4, 5.4**
  
  - [ ]* 10.10 Написать property-тест для успешной валидации
    - **Свойство 7: Успешная валидация разрешает отправку**
    - **Валидирует: Требования 4.5, 5.5**

- [ ] 11. Checkpoint - Проверка фронтенд функциональности
  - Убедиться, что все тесты проходят, спросить пользователя если возникли вопросы

- [ ] 12. Обработка edge cases и специальных сценариев
  - [x] 12.1 Реализовать обработку некорректного validationPattern
    - Добавить try-catch для создания Regex
    - Добавить логирование ошибки
    - Пропустить кастомную валидацию при ошибке
    - _Требования: 14.5_
  
  - [x] 12.2 Реализовать обработку отсутствия validationPattern
    - Проверить, что используется только стандартная валидация
    - _Требования: 14.4_
  
  - [ ]* 12.3 Написать property-тест для обработки некорректного паттерна
    - **Свойство 18: Обработка некорректного validationPattern**
    - **Валидирует: Требования 14.5**
  
  - [ ]* 12.4 Написать unit-тест для пустых значений
    - Проверить обработку пустых строк
    - Проверить обработку строк только с пробелами
    - _Требования: 4.1, 5.1_
  
  - [ ]* 12.5 Написать unit-тест для специальных символов
    - Проверить обработку HTML тегов в значениях
    - Проверить обработку SQL инъекций
    - Проверить обработку XSS атак
    - _Требования: 5.1, 5.2_

- [ ] 13. Регистрация зависимостей в DI контейнере
  - [x] 13.1 Зарегистрировать сервисы в Startup/Composer
    - Зарегистрировать IFormSubmissionRepository → FormSubmissionRepository
    - Зарегистрировать IFormSubmissionService → FormSubmissionService
    - Убедиться, что IEmailService уже зарегистрирован
    - _Требования: 15.1, 15.4_
  
  - [x] 13.2 Настроить конфигурацию reCAPTCHA
    - Добавить настройки reCAPTCHA в appsettings.json (если еще не добавлены)
    - Убедиться, что IReCaptchaService настроен
    - _Требования: 6.1, 15.7_

- [ ] 14. Интеграция с существующей системой Toast notifications
  - [x] 14.1 Проверить существующую реализацию Toast
    - Изучить существующий API Toast notifications
    - Убедиться, что window.toastNotification.show(message, type) доступен
    - _Требования: 9.1, 9.3, 9.4, 9.5, 9.6, 15.6_
  
  - [x] 14.2 Добавить fallback для Toast notifications
    - Добавить проверку наличия window.toastNotification
    - Использовать alert() как fallback
    - _Требования: 9.1, 9.3, 9.6_

- [ ] 15. Финальное тестирование и документация
  - [ ]* 15.1 Запустить все unit-тесты
    - Убедиться, что все unit-тесты проходят
    - Проверить покрытие кода (минимум 80%)
  
  - [ ]* 15.2 Запустить все property-based тесты
    - Убедиться, что все 18 свойств корректности проверены
    - Убедиться, что каждый тест выполняется минимум 100 итераций
  
  - [ ]* 15.3 Запустить integration-тесты
    - Проверить полный цикл отправки формы
    - Проверить все сценарии ошибок
  
  - [x] 15.4 Создать примеры использования
    - Создать пример страницы с формой обратной связи
    - Создать пример страницы с формой подписки
    - _Требования: все_
  
  - [x] 15.5 Написать README для модуля
    - Описать установку и настройку
    - Описать создание форм в бэкофисе
    - Описать настройку email и reCAPTCHA
    - Добавить примеры кода

- [x] 16. Final Checkpoint - Финальная проверка
  - Убедиться, что все тесты проходят
  - Проверить работу всех функций в браузере
  - Спросить пользователя о готовности к деплою

## Примечания

- Задачи, помеченные `*`, являются опциональными и могут быть пропущены для более быстрого MVP
- Каждая задача ссылается на конкретные требования для отслеживаемости
- Checkpoints обеспечивают инкрементальную валидацию
- Property-тесты валидируют универсальные свойства корректности
- Unit-тесты валидируют конкретные примеры и edge cases
- Минимум 100 итераций для каждого property-теста
- Все тесты должны быть помечены тегами: Feature: umbraco-form-builder, Property N: [описание]
