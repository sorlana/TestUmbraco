@using Umbraco.Cms.Core.Models
@using Umbraco.Cms.Core.Models.Blocks
@using Umbraco.Extensions
@using TestUmbraco.Models
@using TestUmbraco.Services
@using CoreLink = Umbraco.Cms.Core.Models.Link   @* ← разрешаем конфликт имён Link *@
@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage<BlockGridItem>
@inject IStaticCssGeneratorService StaticCssGenerator

@{
    var content = Model.Content;
    var settings = Model.Settings;

    // ---------- Фон: применять к родителю? ----------
    var applyBackgroundToParent = ViewData["ApplyBackgroundToParent"] as bool? ?? false;

    // ---------- Свойства карточки ----------
    var cardTitle = content.Value<string>("cardTitle") ?? string.Empty;
    var cardSummary = content.Value<string>("cardSummary") ?? string.Empty;
    var cardImage = content.Value<IPublishedContent>("cardImage");
    var cardDate = content.Value<DateTime?>("cardDate");
    var cardCategory = content.Value<IEnumerable<string>>("cardCategory") ?? Enumerable.Empty<string>();

    // ---------- Ссылки ----------
    var cardImgLink = content.Value<CoreLink>("cardImgLink");
    
    // cardLink это BlockListItem с блоком link внутри
    CoreLink? cardLink = null;
    var debugCardLinkBlock = "null";
    var debugCardLinkType = "no type";
    var debugLinkProperties = "";
    
    // Получаем raw value как BlockListItem
    var rawValue = content.GetProperty("cardLink")?.GetValue();
    if (rawValue != null)
    {
        debugCardLinkBlock = $"RawType: {rawValue.GetType().Name}";
        
        // Приводим к BlockListItem
        if (rawValue is Umbraco.Cms.Core.Models.Blocks.BlockListItem blockListItem)
        {
            debugCardLinkType = blockListItem.Content?.ContentType?.Alias ?? "no alias";
            debugCardLinkBlock = "BlockListItem cast success";
            
            if (blockListItem.Content != null)
            {
                // Выводим все свойства блока link
                debugLinkProperties = string.Join(", ", blockListItem.Content.Properties.Select(p => p.Alias));
                
                // В link.cshtml linkUrl это string, а не CoreLink
                var linkUrlString = blockListItem.Content.Value<string>("linkUrl");
                var linkText = blockListItem.Content.Value<string>("textLink") ?? linkUrlString;
                var showAsButton = blockListItem.Content.Value<bool>("showAsButton");
                
                // Создаем CoreLink из данных
                if (!string.IsNullOrWhiteSpace(linkUrlString))
                {
                    cardLink = new CoreLink
                    {
                        Url = linkUrlString,
                        Name = linkText,
                        Target = "_self"
                    };
                }
            }
        }
    }
    
    var debugCardLink = cardLink != null ? "not null" : "null";
    var debugCardLinkUrl = cardLink?.Url ?? "no url";

    // ---------- Обёртка и стили ----------
    var wrapperTag = content.Value<string>("tag") ?? "div";
    var customClass = content.Value<string>("Class") ?? "";
    
    // Извлекаем класс анимации из строки вида "bounce (Привлекающие внимание)"
    if (!string.IsNullOrWhiteSpace(customClass) && customClass.Contains("("))
    {
        var animateClass = customClass.Split('(')[0].Trim();
        customClass = animateClass;
    }
    
    // ---------- Цвет текста ----------
    var textColor = "";
    if (content.HasProperty("textInverse") && content.HasValue("textInverse"))
    {
        textColor = content.Value<string>("textInverse") ?? "";
    }
    
    // Применяем textColor если задан
    if (!string.IsNullOrWhiteSpace(textColor))
    {
        var textColorClass = $"text-color-{content.Key:N}";
        customClass += $" {textColorClass}";
        
        var textColorCss = $@"
.{textColorClass},
.{textColorClass} * {{
    color: {textColor} !important;
}}";
        
        await StaticCssGenerator.AddInlineStyleAsync(textColorCss, "textcolor");
    }

    // ---------- Вспомогательные флаги ----------
    var hasImgLink = cardImgLink != null && !string.IsNullOrWhiteSpace(cardImgLink.Url);
    var hasCardLink = cardLink != null && !string.IsNullOrWhiteSpace(cardLink.Url);

    // ---------- ФОРМИРУЕМ СОДЕРЖИМОЕ КАРТОЧКИ (как делегат для _BackgroundClasses) ----------
    Func<object, IHtmlContent> cardContent = @<text>
        @if (hasImgLink && cardImgLink != null)
        {
            <a href="@cardImgLink.Url" target="@cardImgLink.Target" class="card-link-wrapper">
                @RenderCardInner()
            </a>
        }
        else
        {
            @RenderCardInner()
        }
    </text>;

    // Вспомогательная функция для внутренней части (чтобы не дублировать)
    IHtmlContent RenderCardInner()
    {
        var sb = new System.Text.StringBuilder();
        
        // Отладка: добавляем комментарий
        sb.Append($"<!-- Card Debug: method={debugCardLinkBlock}, type={debugCardLinkType}, linkProps=[{debugLinkProperties}], cardLink={debugCardLink}, URL={debugCardLinkUrl}, hasCardLink={hasCardLink} -->");
        
        // Если есть ссылка-кнопка, добавляем bootstrap-scope
        if (hasCardLink)
        {
            sb.Append("<div class=\"bootstrap-scope\">");
        }
        
        sb.Append($"<div class=\"card {customClass}\">");
        
        // Изображение
        if (cardImage != null)
        {
            sb.Append($"<img src=\"{cardImage.Url()}\" class=\"card-img-top\" alt=\"{cardTitle ?? "Card image"}\">");
        }
        
        sb.Append("<div class=\"card-body\">");
        
        // Дата
        if (cardDate.HasValue)
        {
            sb.Append($"<small class=\"card-date text-muted\">{cardDate.Value:dd MMM yyyy}</small>");
        }
        
        // Категории
        if (cardCategory?.Any() == true)
        {
            sb.Append("<div class=\"card-categories\">");
            foreach (var cat in cardCategory)
            {
                sb.Append($"<span class=\"badge bg-secondary me-1\">{cat}</span>");
            }
            sb.Append("</div>");
        }
        
        // Заголовок
        if (!string.IsNullOrWhiteSpace(cardTitle))
        {
            sb.Append($"<h3 class=\"card-title h5\">{cardTitle}</h3>");
        }
        
        // Описание
        if (!string.IsNullOrWhiteSpace(cardSummary))
        {
            sb.Append($"<div class=\"card-text\">{cardSummary}</div>");
        }
        
        // Ссылка
        if (hasCardLink)
        {
            var linkTarget = cardLink?.Target != null && !string.IsNullOrWhiteSpace(cardLink.Target) ? $" target=\"{cardLink.Target}\"" : "";
            var linkRel = cardLink?.Target != null && !string.IsNullOrWhiteSpace(cardLink.Target) ? " rel=\"noopener\"" : "";
            var linkText = string.IsNullOrWhiteSpace(cardLink?.Name) ? "Подробнее" : cardLink.Name;
            sb.Append($"<a href=\"{cardLink?.Url}\"{linkTarget}{linkRel} class=\"btn btn-primary mt-2\">{linkText}</a>");
        }
        else
        {
            sb.Append("<!-- No card link: hasCardLink is false -->");
        }
        
        sb.Append("</div>"); // card-body
        sb.Append("</div>"); // card
        
        if (hasCardLink)
        {
            sb.Append("</div>"); // bootstrap-scope
        }
        
        return new HtmlString(sb.ToString());
    }
}

@* =============================================================================
ВЫВОД С УЧЁТОМ ФОНА (через _BackgroundClasses)
============================================================================= *@
@if (applyBackgroundToParent)
{
@* Фон уже применён к родителю — рендерим только содержимое карточки *@
@cardContent(new object())
}
else
{
var backgroundModel = new BackgroundClassesModel
{
    Settings = settings,
    ComponentId = content.Key,
    Prefix = "card-bg",
    BaseClass = "",
    AdditionalClasses = "",
    Tag = wrapperTag,
    ContainerClass = "",
    Content = cardContent   // передаём делегат
};

<partial name="_BackgroundClasses" model="backgroundModel" />
}