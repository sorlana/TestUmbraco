@using Umbraco.Cms.Core.Models.Blocks
@using TestUmbraco.Services
@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage<BlockGridItem>
@inject IUmbracoBackgroundService BackgroundService

@{
    var content = Model.Content;
    var settings = Model.Settings;
    var rows = content.Value<BlockListModel>("rows");
    
    // Получаем классы из настроек или из контента
    var sectionClass = "";
    var containerClass = "";
    
    if (settings != null)
    {
        sectionClass = settings.Value<string>("sectionClass") ?? "";
        containerClass = settings.Value<string>("containerClass") ?? "";
    }
    
    if (string.IsNullOrWhiteSpace(sectionClass))
    {
        sectionClass = content.Value<string>("sectionClass") ?? "";
    }
    
    if (string.IsNullOrWhiteSpace(containerClass))
    {
        containerClass = content.Value<string>("containerClass") ?? "";
    }
    
    // Используем сервис для обработки фона
    var backgroundResult = BackgroundService.ProcessBackground(settings, content.Key, "grid-bg");
    var bgClass = backgroundResult.CssClass;
}

@if (rows != null && rows.Any())
{
    // Открываем section с классом или без
    if (string.IsNullOrWhiteSpace(sectionClass))
    {
        if (!string.IsNullOrWhiteSpace(bgClass))
        {
            @:<section class="@bgClass">
        }
        else
        {
            @:<section>
        }
    }
    else
    {
        if (!string.IsNullOrWhiteSpace(bgClass))
        {
            @:<section class="@sectionClass.Trim() @bgClass">
        }
        else
        {
            @:<section class="@sectionClass.Trim()">
        }
    }
    
        <div class="container @(string.IsNullOrWhiteSpace(containerClass) ? "" : containerClass.Trim())">
            @foreach (var row in rows)
            {
                @await Html.PartialAsync($"blockgrid/Components/{row.Content.ContentType.Alias}", row)
            }
        </div>
    
    @:</section>
}