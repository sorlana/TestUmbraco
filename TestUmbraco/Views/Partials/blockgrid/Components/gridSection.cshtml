@using Umbraco.Cms.Core.Models.Blocks
@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage<BlockGridItem>

@{
    var content = Model.Content;
    var settings = Model.Settings;
    var rows = content.Value<BlockListModel>("rows");
    
    var sectionClass = settings?.Value<string>("sectionClass") ?? content.Value<string>("sectionClass");
    var containerClass = settings?.Value<string>("containerClass") ?? content.Value<string>("containerClass");
    
    // Определяем класс для фона
    var bgClass = "";
    
    // Проверяем наличие фонового изображения в Settings model
    if (settings != null && settings.HasProperty("backgroundImage") && settings.HasValue("backgroundImage"))
    {
        var bgImage = settings.Value<IPublishedContent>("backgroundImage");
        if (bgImage != null)
        {
            // Создаем уникальный класс для этой секции
            bgClass = $"grid-bg-{content.Key.ToString().Replace("-", "").Substring(0, 8)}";
            
            // Получаем дополнительные настройки фона
            var minHeight = settings.HasValue("minHeight") ? settings.Value<int>("minHeight") : 400;
            var bgSize = settings.HasValue("backgroundSize") ? settings.Value<string>("backgroundSize") : "cover";
            var bgPosition = settings.HasValue("backgroundPosition") ? settings.Value<string>("backgroundPosition") : "center";
            
            // Формируем параметр для API
            var backgroundParam = $"{bgImage.Key}:{bgClass}:{minHeight}:{bgSize}:{bgPosition}";
            
            // Добавляем в Context.Items
            var backgroundParams = Context.Items["BackgroundParams"] as List<string>;
            if (backgroundParams == null)
            {
                backgroundParams = new List<string>();
                Context.Items["BackgroundParams"] = backgroundParams;
            }
            backgroundParams.Add(backgroundParam);
        }
    }
}

@if (rows != null && rows.Any())
{
    // Открываем section с классом или без
    if (string.IsNullOrWhiteSpace(sectionClass))
    {
        @:<section class="@bgClass">
    }
    else
    {
        @:<section class="@sectionClass.Trim() @bgClass">
    }
    
        <div class="container @(string.IsNullOrWhiteSpace(containerClass) ? "" : containerClass.Trim())">
            @foreach (var row in rows)
            {
                @await Html.PartialAsync($"blockgrid/Components/{row.Content.ContentType.Alias}", row)
            }
        </div>
    
    @:</section>
}