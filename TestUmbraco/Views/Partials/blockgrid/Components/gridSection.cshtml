@using Umbraco.Cms.Core.Models.Blocks
@using TestUmbraco.Models
@using TestUmbraco.Services
@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage<BlockGridItem>
@inject IStaticCssGeneratorService StaticCssGenerator

@{
    var content = (IPublishedElement?)Model.Content;
    var settings = (IPublishedElement?)Model.Settings;
    
    // Получаем вложенный BlockGrid из свойства "rows"
    var gridRows = content?.Value<BlockGridModel>("rows");
    
    var sectionClass = "";
    var containerClass = "";
    var idSection = "";
    var textInverseColor = "";
    
    if (settings != null)
    {
        sectionClass = settings.Value<string>("sectionClass") ?? "";
        containerClass = settings.Value<string>("containerClass") ?? "";
        idSection = settings.Value<string>("idSection") ?? "";
        
        // Получаем цвет для textInverse
        if (settings.HasProperty("textInverse") && settings.HasValue("textInverse"))
        {
            textInverseColor = settings.Value<string>("textInverse") ?? "";
        }
    }
    
    if (string.IsNullOrWhiteSpace(sectionClass))
    {
        sectionClass = content?.Value<string>("sectionClass") ?? "";
    }
    
    if (string.IsNullOrWhiteSpace(containerClass))
    {
        containerClass = content?.Value<string>("containerClass") ?? "";
    }
    
    if (string.IsNullOrWhiteSpace(idSection))
    {
        idSection = content?.Value<string>("idSection") ?? "";
    }
    
    // Добавляем класс для textInverse если задан цвет
    if (!string.IsNullOrWhiteSpace(textInverseColor))
    {
        var textInverseClass = $"text-inverse-{content?.Key:N}";
        sectionClass += $" {textInverseClass}";
        
        // Генерируем CSS для textInverse через сервис
        var textInverseCss = $@"
.{textInverseClass},
.{textInverseClass} *,
.{textInverseClass} h1,
.{textInverseClass} h2,
.{textInverseClass} h3,
.{textInverseClass} h4,
.{textInverseClass} h5,
.{textInverseClass} h6,
.{textInverseClass} p,
.{textInverseClass} span,
.{textInverseClass} a,
.{textInverseClass} li,
.{textInverseClass} td,
.{textInverseClass} th {{
    color: {textInverseColor} !important;
}}";
        
        // Добавляем через сервис в backgrounds.css
        await StaticCssGenerator.AddInlineStyleAsync(textInverseCss, "textinverse");
    }
}

@if (gridRows != null && gridRows.Any())
{
    // Создаем функцию для контента section (container)
    Func<object, Microsoft.AspNetCore.Html.IHtmlContent>? sectionContentFunc = 
        @<text>
            <div class="container @containerClass.Trim()">
                @* Рендерим дочерние элементы (gridColumn) - они сами создадут row с фоном *@
                @foreach (var gridRow in gridRows)
                {
                    @await Html.PartialAsync($"blockgrid/Components/{gridRow.Content.ContentType.Alias}", gridRow)
                }
            </div>
        </text>;

    // Создаем модель для BackgroundClasses - применяем к section
    var backgroundModel = new BackgroundClassesModel
    {
        Settings = settings,
        ComponentId = content?.Key,
        Prefix = "gridsection-bg",
        BaseClass = sectionClass.Trim(),
        AdditionalClasses = "",
        Tag = "section",
        ContainerClass = "",
        ElementId = idSection.Trim(),
        Content = sectionContentFunc
    };

    // Рендерим section через универсальный компонент с фоном
    <partial name="_BackgroundClasses" model="backgroundModel" />
}
else
{
    <section class="@sectionClass.Trim()" style="border: 2px solid red; padding: 20px; margin: 10px;">
        <div class="container @containerClass.Trim()">
            <p style="color: red;">
                <strong>GridSection Error:</strong> No rows configured. Please add content to this section in Umbraco.
            </p>
        </div>
    </section>
}