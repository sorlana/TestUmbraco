@using Umbraco.Cms.Core.Models.Blocks
@using TestUmbraco.Models
@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage<BlockGridItem>

@{
    var content = Model.Content;
    var settings = Model.Settings;
    
    // Получаем вложенный BlockGrid из свойства "content"
    var gridContent = content.Value<BlockGridModel>("content");
    
    var sectionClass = "";
    var containerClass = "";
    
    if (settings != null)
    {
        sectionClass = settings.Value<string>("sectionClass") ?? "";
        containerClass = settings.Value<string>("containerClass") ?? "";
    }
    
    if (string.IsNullOrWhiteSpace(sectionClass))
    {
        sectionClass = content.Value<string>("sectionClass") ?? "";
    }
    
    if (string.IsNullOrWhiteSpace(containerClass))
    {
        containerClass = content.Value<string>("containerClass") ?? "";
    }
    
    // Получаем дополнительные свойства
    var classRow = content.Value<string>("classRow") ?? "";
    var bootstrap = content.Value<string>("bootstrap") ?? "";
    var typeBlock = content.Value<bool>("typeBlock");
    
    // Определяем теги в зависимости от typeBlock
    var rowTag = typeBlock ? "ul" : "div";
    var colTag = typeBlock ? "li" : "div";
}

@* Рендерим gridColumn - создаем row с фоном, внутри несколько col *@
@{
    // Создаем функцию для контента row (несколько col)
    Func<object, Microsoft.AspNetCore.Html.IHtmlContent>? rowContentFunc = 
        @<text>
            @if (gridContent != null && gridContent.Any())
            {
                @* Каждый элемент content рендерится в отдельном col *@
                foreach (var item in gridContent)
                {
                    var componentAlias = item.Content.ContentType.Alias;
                    
                    // Определяем класс колонки для каждого элемента
                    string itemColumnClass = "";
                    
                    if (!string.IsNullOrWhiteSpace(bootstrap))
                    {
                        // Если выбрано значение в bootstrap - все колонки одинакового размера
                        if (int.TryParse(bootstrap, out int columnsPerRow) && columnsPerRow > 0 && columnsPerRow <= 12)
                        {
                            int columnSize = 12 / columnsPerRow;
                            itemColumnClass = $"col-{columnSize}";
                        }
                        else
                        {
                            itemColumnClass = $"col-{item.ColumnSpan}";
                        }
                    }
                    else
                    {
                        // Если bootstrap не выбран - используем размер области каждого элемента
                        itemColumnClass = $"col-{item.ColumnSpan}";
                    }
                    
                    @* Для компонентов с фоном используем специальный helper *@
                    @if (componentAlias == "textEditor" || componentAlias == "img" || componentAlias == "quote" || componentAlias == "video" || componentAlias == "separator" || componentAlias == "title")
                    {
                        @await Html.PartialAsync("blockgrid/_ColumnWithBackground", new {
                            Item = item,
                            ColTag = colTag,
                            ItemColumnClass = itemColumnClass,
                            ClassRow = classRow.Trim(),
                            ContainerClass = containerClass,
                            ComponentAlias = componentAlias
                        })
                    }
                    else
                    {
                        @* Для остальных компонентов рендерим обычную колонку *@
                        @Html.Raw($"<{colTag} class=\"{itemColumnClass} {classRow.Trim()}\">")
                            @if (!string.IsNullOrWhiteSpace(containerClass))
                            {
                                <div class="@containerClass.Trim()">
                                    @await Html.PartialAsync($"blockgrid/Components/{componentAlias}", item)
                                </div>
                            }
                            else
                            {
                                @await Html.PartialAsync($"blockgrid/Components/{componentAlias}", item)
                            }
                        @Html.Raw($"</{colTag}>")
                    }
                }
            }
            else
            {
                @Html.Raw($"<{colTag} class=\"col-12\">")
                    <p style="color: orange; border: 2px solid orange; padding: 5px;">
                        GridColumn: No content configured. Add content blocks in Umbraco.
                    </p>
                @Html.Raw($"</{colTag}>")
            }
        </text>;

    // Создаем модель для BackgroundClasses - применяем к row
    var backgroundModel = new BackgroundClassesModel
    {
        Settings = settings,
        ComponentId = content.Key,
        Prefix = "gridcolumn-bg",
        BaseClass = "row",
        AdditionalClasses = "",
        Tag = rowTag,
        ContainerClass = "",
        Content = rowContentFunc
    };

    // Рендерим row через универсальный компонент с фоном
    <partial name="_BackgroundClasses" model="backgroundModel" />
}