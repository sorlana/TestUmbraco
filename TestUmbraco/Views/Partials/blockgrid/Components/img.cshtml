@using Umbraco.Cms.Core.Models
@using Umbraco.Cms.Core.Models.Blocks
@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage<BlockGridItem>

@{
    var content = Model.Content;
    
    // Получаем свойства карточки - ИСПРАВЛЕНО: используем "image" вместо "img"
    var image = content.Value<IPublishedContent>("image"); // ← ИСПРАВЛЕНО!
    var showCaption = content.Value<bool>("imgToggle");
    var caption = content.Value<string>("imgDescription") ?? string.Empty;
    
    // Дополнительные свойства карточки
    var cardTitle = content.Value<string>("title") ?? string.Empty;
    var cardText = content.Value<string>("text") ?? string.Empty;
    var link = content.Value<Link>("link");
    
    // Alt текст для изображения
    var altText = content.Value<string>("altText") ?? image?.Name ?? string.Empty;
    
    // CSS классы
    var cardClass = content.Value<string>("class") ?? "card";
    var imageClass = content.Value<string>("imageClass") ?? "card-img-top";
    
    // Параметры изображения
    var cropAlias = "card";
    var lazyLoad = true;
    var useCache = true;
    
    // DEBUG информация
    var hasImage = image != null;
    var imageInfo = hasImage ? $"Key={image.Key}, Name={image.Name}" : "NULL";
}


<div class="@cardClass">
    @if (image != null)
    {
        // Подготавливаем данные для передачи в _Image.cshtml
        var viewData = new ViewDataDictionary(ViewData)
        {
            { "CssClass", imageClass },
            { "CropAlias", cropAlias },
            { "LazyLoad", lazyLoad },
            { "UseCache", useCache },
            { "ShowCaption", showCaption },
            { "Caption", caption },
            { "AltText", altText },
            { "Title", altText }
        };
        
        // Атрибуты для тега img
        var attributes = new Dictionary<string, string>
        {
            { "data-component", "card-image" },
            { "data-optimized", "true" },
            { "data-lazyload", "true" }
        };
        
        viewData["Attributes"] = attributes;
        
        // Рендерим через частичное представление
        <partial name="_Image" model="image" view-data="viewData" />
    }
    else
    {
        <!-- Placeholder если изображение не выбрано -->
        <div class="card-image-placeholder @imageClass">
            <div class="placeholder-content">
                <svg class="placeholder-icon" width="60" height="60" viewBox="0 0 24 24">
                    <path fill="#999" d="M21,3H3C1.9,3,1,3.9,1,5v14c0,1.1,0.9,2,2,2h18c1.1,0,2-0.9,2-2V5C23,3.9,22.1,3,21,3z M21,19H3V5h18V19z"/>
                    <circle fill="#999" cx="9" cy="10" r="3"/>
                    <path fill="#999" d="M19,7h-6v6h6V7z"/>
                </svg>
                <span class="placeholder-text">Изображение не выбрано</span>
            </div>
        </div>
    }
    
    @if (!string.IsNullOrEmpty(cardTitle) || !string.IsNullOrEmpty(cardText) || link != null)
    {
        <div class="card-body">
            @if (!string.IsNullOrEmpty(cardTitle))
            {
                <h3 class="card-title">@cardTitle</h3>
            }
            
            @if (!string.IsNullOrEmpty(cardText))
            {
                <div class="card-text">
                    @Html.Raw(cardText)
                </div>
            }
            
            @if (link != null)
            {
                <a href="@link.Url" 
                   target="@link.Target" 
                   class="btn btn-primary card-link">
                    @(link.Name ?? "Подробнее")
                </a>
            }
        </div>
    }
    
    @if (showCaption && !string.IsNullOrEmpty(caption) && image == null)
    {
        <div class="card-footer">
            <small class="text-muted">@caption</small>
        </div>
    }
</div>

<style>
    .card {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        overflow: hidden;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        background: white;
    }
    
    .card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }
    
    .card-image-placeholder {
        background: #f8f9fa;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 200px;
        color: #6c757d;
    }
    
    .placeholder-content {
        text-align: center;
    }
    
    .placeholder-icon {
        opacity: 0.5;
        margin-bottom: 10px;
    }
    
    .placeholder-text {
        display: block;
        font-size: 14px;
    }
    
    .card-body {
        padding: 20px;
    }
    
    .card-title {
        margin-top: 0;
        margin-bottom: 10px;
        font-size: 1.25rem;
    }
    
    .card-text {
        margin-bottom: 15px;
        color: #555;
    }
    
    .card-footer {
        padding: 10px 20px;
        background-color: #f8f9fa;
        border-top: 1px solid #e0e0e0;
    }
    
    .card-link {
        display: inline-block;
        padding: 8px 16px;
        background: #007bff;
        color: white;
        text-decoration: none;
        border-radius: 4px;
        transition: background 0.3s ease;
    }
    
    .card-link:hover {
        background: #0056b3;
        color: white;
        text-decoration: none;
    }
</style>