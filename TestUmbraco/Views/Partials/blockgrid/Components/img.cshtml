@using Umbraco.Cms.Core.Models
@using Umbraco.Cms.Core.Models.Blocks
@using TestUmbraco.Models
@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage<BlockGridItem>

@{
    var content = Model.Content;
    var settings = Model.Settings;
    
    // Проверяем, нужно ли применять фон к родителю
    var applyBackgroundToParent = ViewData["ApplyBackgroundToParent"] as bool? ?? false;
    
    var image = content.Value<IPublishedContent>("image");
    var showCaption = content.Value<bool>("imgToggle");
    var caption = content.Value<string>("imgDescription") ?? string.Empty;
    
    // Дополнительные свойства карточки
    var cardTitle = content.Value<string>("title") ?? string.Empty;
    var cardText = content.Value<string>("text") ?? string.Empty;
    var linkUrl = content.Value<string>("link");
    
    // Alt текст для изображения
    var altText = content.Value<string>("altText") ?? image?.Name ?? string.Empty;
    
    // CSS классы
    var cardClass = content.Value<string>("class");
    var imageClass = content.Value<string>("imageClass") ?? "card-img-top";
    
    // Параметры изображения
    var cropAlias = "card";
    var lazyLoad = true;
    var useCache = true;
}

@if (applyBackgroundToParent)
{
    @* Фон применяется к родительскому элементу, рендерим только контент без обертки *@
    @if (image != null)
    {
        // Подготавливаем данные для передачи в _Image.cshtml
        var viewData = new ViewDataDictionary<IPublishedContent>(ViewData, image)
        {
            { "CssClass", imageClass },
            { "CropAlias", cropAlias },
            { "LazyLoad", lazyLoad },
            { "UseCache", useCache },
            { "ShowCaption", showCaption },
            { "Caption", caption },
            { "AltText", altText },
            { "Title", altText }
        };
        
        // Атрибуты для тега img
        var attributes = new Dictionary<string, string>
        {
            { "data-component", "card-image" },
            { "data-optimized", "true" },
            { "data-lazyload", "true" }
        };
        
        viewData["Attributes"] = attributes;
        
        // Рендерим через частичное представление
        <partial name="_Image" model="image" view-data="viewData" />
    }
    else
    {
        <!-- Placeholder если изображение не выбрано -->
        <div class="card-image-placeholder @imageClass">
            <div class="placeholder-content">
                <svg class="placeholder-icon" width="60" height="60" viewBox="0 0 24 24">
                    <path fill="#999" d="M21,3H3C1.9,3,1,3.9,1,5v14c0,1.1,0.9,2,2,2h18c1.1,0,2-0.9,2-2V5C23,3.9,22.1,3,21,3z M21,19H3V5h18V19z"/>
                    <circle fill="#999" cx="9" cy="10" r="3"/>
                    <path fill="#999" d="M19,7h-6v6h6V7z"/>
                </svg>
                <span class="placeholder-text">Изображение не выбрано</span>
            </div>
        </div>
    }
    
    @if (!string.IsNullOrEmpty(cardTitle) || !string.IsNullOrEmpty(cardText) || !string.IsNullOrEmpty(linkUrl))
    {
        <div class="card-body">
            @if (!string.IsNullOrEmpty(cardTitle))
            {
                <h3 class="card-title">@cardTitle</h3>
            }
            
            @if (!string.IsNullOrEmpty(cardText))
            {
                <div class="card-text">
                    @Html.Raw(cardText)
                </div>
            }
            
            @if (!string.IsNullOrEmpty(linkUrl))
            {
                <a href="@linkUrl" 
                   class="btn btn-primary card-link">
                    Подробнее
                </a>
            }
        </div>
    }
    
    @if (showCaption && !string.IsNullOrEmpty(caption) && image == null)
    {
        <div class="card-footer">
            <small class="text-muted">@caption</small>
        </div>
    }
}
else
{
    @* Обычный рендеринг с фоном *@
    // Создаем функцию для контента
    Func<object, Microsoft.AspNetCore.Html.IHtmlContent>? contentFunc = 
        @<text>
            @if (image != null)
            {
                // Подготавливаем данные для передачи в _Image.cshtml
                var viewData = new ViewDataDictionary<IPublishedContent>(ViewData, image)
                {
                    { "CssClass", imageClass },
                    { "CropAlias", cropAlias },
                    { "LazyLoad", lazyLoad },
                    { "UseCache", useCache },
                    { "ShowCaption", showCaption },
                    { "Caption", caption },
                    { "AltText", altText },
                    { "Title", altText }
                };
                
                // Атрибуты для тега img
                var attributes = new Dictionary<string, string>
                {
                    { "data-component", "card-image" },
                    { "data-optimized", "true" },
                    { "data-lazyload", "true" }
                };
                
                viewData["Attributes"] = attributes;
                
                // Рендерим через частичное представление
                <partial name="_Image" model="image" view-data="viewData" />
            }
            else
            {
                <!-- Placeholder если изображение не выбрано -->
                <div class="card-image-placeholder @imageClass">
                    <div class="placeholder-content">
                        <svg class="placeholder-icon" width="60" height="60" viewBox="0 0 24 24">
                            <path fill="#999" d="M21,3H3C1.9,3,1,3.9,1,5v14c0,1.1,0.9,2,2,2h18c1.1,0,2-0.9,2-2V5C23,3.9,22.1,3,21,3z M21,19H3V5h18V19z"/>
                            <circle fill="#999" cx="9" cy="10" r="3"/>
                            <path fill="#999" d="M19,7h-6v6h6V7z"/>
                        </svg>
                        <span class="placeholder-text">Изображение не выбрано</span>
                    </div>
                </div>
            }
            
            @if (!string.IsNullOrEmpty(cardTitle) || !string.IsNullOrEmpty(cardText) || !string.IsNullOrEmpty(linkUrl))
            {
                <div class="card-body">
                    @if (!string.IsNullOrEmpty(cardTitle))
                    {
                        <h3 class="card-title">@cardTitle</h3>
                    }
                    
                    @if (!string.IsNullOrEmpty(cardText))
                    {
                        <div class="card-text">
                            @Html.Raw(cardText)
                        </div>
                    }
                    
                    @if (!string.IsNullOrEmpty(linkUrl))
                    {
                        <a href="@linkUrl" 
                           class="btn btn-primary card-link">
                            Подробнее
                        </a>
                    }
                </div>
            }
            
            @if (showCaption && !string.IsNullOrEmpty(caption) && image == null)
            {
                <div class="card-footer">
                    <small class="text-muted">@caption</small>
                </div>
            }
        </text>;

    // Создаем модель для BackgroundClasses
    var backgroundModel = new BackgroundClassesModel
    {
        Settings = settings,
        ComponentId = content.Key,
        Prefix = "img-bg",
        BaseClass = cardClass ?? "",
        AdditionalClasses = "",
        Tag = "div",
        ContainerClass = "",
        Content = contentFunc
    };

    // Рендерим через универсальный компонент
    <partial name="_BackgroundClasses" model="backgroundModel" />
}