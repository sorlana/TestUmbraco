@using Umbraco.Cms.Core.Models.Blocks
@using Umbraco.Cms.Core.Models.PublishedContent
@using TestUmbraco.Models
@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage

<!-- DEBUG: _RegisterBackgrounds.cshtml started -->

@{
    var pageBackgrounds = ViewBag.PageBackgrounds as PageBackgroundsModel;
    
    if (pageBackgrounds == null)
    {
        pageBackgrounds = new PageBackgroundsModel();
        ViewBag.PageBackgrounds = pageBackgrounds;
    }
    
    // Всегда добавляем тестовый фон для отладки
    pageBackgrounds.Backgrounds.Add(new BackgroundItem
    {
        MediaGuid = "00000000-0000-0000-0000-000000000001",
        CssClass = "test-bg-debug",
        MinHeight = 500,
        Size = "cover",
        Position = "center"
    });
    
    // Проверяем текущую страницу на наличие фона
    if (Model != null)
    {
        <text><!-- DEBUG: Model type: @Model.GetType().Name, Id: @Model.Id --></text>
        
        // 1. Фон самой страницы
        if (Model.HasProperty("backgroundImage") && Model.HasValue("backgroundImage"))
        {
            <text><!-- DEBUG: Page has backgroundImage property --></text>
            var backgroundImage = Model.Value<IPublishedContent>("backgroundImage");
            if (backgroundImage != null)
            {
                <text><!-- DEBUG: Found background image with key: @backgroundImage.Key --></text>
                pageBackgrounds.Backgrounds.Add(new BackgroundItem
                {
                    MediaGuid = backgroundImage.Key.ToString(),
                    CssClass = $"page-bg-{Model.Id}",
                    MinHeight = 400,
                    Size = "cover",
                    Position = "center"
                });
            }
        }
        else
        {
            <text><!-- DEBUG: Page has NO backgroundImage property --></text>
        }
        
        // 2. Проверяем другие свойства на наличие контента с фонами
        var propertiesToCheck = new[] { "grid", "content", "sections", "blocks", "gridContent", "contentGrid", "sectionsGrid", "bodyText", "contentBlocks" };
        
        foreach (var propName in propertiesToCheck)
        {
            if (Model.HasProperty(propName))
            {
                <text><!-- DEBUG: Page has property: @propName --></text>
                if (Model.HasValue(propName))
                {
                    <text><!-- DEBUG: Property @propName has value --></text>
                    
                    // Пробуем разные типы данных
                    try
                    {
                        // Пробуем как BlockGridModel
                        var grid = Model.Value<BlockGridModel>(propName);
                        if (grid != null)
                        {
                            <text><!-- DEBUG: Property @propName is BlockGridModel with @grid.Count() items --></text>
                            ProcessBlockGridModel(grid, pageBackgrounds);
                        }
                    }
                    catch { }
                    
                    try
                    {
                        // Пробуем как BlockListModel
                        var blocks = Model.Value<BlockListModel>(propName);
                        if (blocks != null)
                        {
                            <text><!-- DEBUG: Property @propName is BlockListModel with @blocks.Count() items --></text>
                            ProcessBlockListModel(blocks, pageBackgrounds);
                        }
                    }
                    catch { }
                }
            }
        }
    }
    else
    {
        <text><!-- DEBUG: Model is NULL --></text>
    }
    
    <text><!-- DEBUG: Total backgrounds found: @pageBackgrounds.Backgrounds.Count --></text>
}

@functions {
    void ProcessBlockGridModel(BlockGridModel grid, PageBackgroundsModel pageBackgrounds)
    {
        foreach (var item in grid)
        {
            CheckElementForBackground(item.Content, pageBackgrounds, "grid");
            
            // Рекурсивно проверяем вложенные блоки
            if (item.Content.HasProperty("rows") && item.Content.HasValue("rows"))
            {
                var rows = item.Content.Value<BlockListModel>("rows");
                if (rows != null)
                {
                    ProcessBlockListModel(rows, pageBackgrounds);
                }
            }
        }
    }
    
    void ProcessBlockListModel(BlockListModel blocks, PageBackgroundsModel pageBackgrounds)
    {
        foreach (var block in blocks)
        {
            CheckElementForBackground(block.Content, pageBackgrounds, "block");
        }
    }
    
    void CheckElementForBackground(IPublishedElement element, PageBackgroundsModel pageBackgrounds, string type)
    {
        if (element.HasProperty("backgroundImage") && element.HasValue("backgroundImage"))
        {
            <text><!-- DEBUG: Found element with backgroundImage: @element.ContentType.Alias, Key: @element.Key --></text>
            
            var bgImage = element.Value<IPublishedContent>("backgroundImage");
            if (bgImage != null)
            {
                <text><!-- DEBUG: Background image key: @bgImage.Key --></text>
                
                pageBackgrounds.Backgrounds.Add(new BackgroundItem
                {
                    MediaGuid = bgImage.Key.ToString(),
                    CssClass = $"{type}-bg-{element.Key}",
                    MinHeight = 300,
                    Size = "cover",
                    Position = "center"
                });
            }
        }
    }
}