@using Umbraco.Cms.Web.Common.PublishedModels;
@using Umbraco.Cms.Core.Models.Blocks;
@using ContentModels = Umbraco.Cms.Web.Common.PublishedModels;
@model IPublishedContent

@{
    // Получаем страницу как BlockGrid
    var blockGridPage = Model as ContentModels.BlockGrid;
    
    // Общие свойства
    var logo = blockGridPage?.Value<IPublishedContent>("logo");
    var showLanguage = blockGridPage?.Value<bool>("showLanquage") ?? false;
    var showLk = blockGridPage?.Value<bool>("showLk") ?? false;
    var buttonName = blockGridPage?.Value<string>("buttonName");
    var showTel = blockGridPage?.Value<bool>("showTel") ?? false;
    
    // Получаем menu как Block Single
    var menuBlock = blockGridPage?.GetProperty("menu")?.GetValue();
    
    // Переменные для меню
    IEnumerable<IPublishedContent>? menuItems = null;
    BlockListModel? menuLandingItems = null;
    bool hasMenu = false;
    bool hasMenuLanding = false;
    List<IPublishedContent>? filteredMenuItems = null;
    
    if (menuBlock != null && menuBlock is Umbraco.Cms.Core.Models.Blocks.BlockListItem menuBlockItem)
    {
        var menuType = menuBlockItem.Content?.ContentType?.Alias;
        
        if (menuType == "menuSite")
        {
            // Это меню сайта
            menuItems = menuBlockItem.Content?.Value<IEnumerable<IPublishedContent>>("menu");
            filteredMenuItems = menuItems?.Where(item => 
                !item.Name.Equals("Home", StringComparison.OrdinalIgnoreCase) &&
                !item.Name.Equals("Главная", StringComparison.OrdinalIgnoreCase)
            ).ToList();
            hasMenu = filteredMenuItems != null && filteredMenuItems.Any();
        }
        else if (menuType == "menuLanding")
        {
            // Это меню лендинга - получаем список пунктов меню
            if (menuBlockItem.Content != null)
            {
                // Получаем BlockList с алиасом navLanding
                menuLandingItems = menuBlockItem.Content.Value<BlockListModel>("navLanding");
                hasMenuLanding = menuLandingItems != null && menuLandingItems.Any();
            }
        }
    }
    
    // Данные для JS
    var menuLandingData = new List<object>();
    if (hasMenuLanding)
    {
        foreach (var blockItem in menuLandingItems)
        {
            var nameItem = blockItem.Content.Value<string>("nameItem");
            var idItem = blockItem.Content.Value<string>("idItem");
            var show = blockItem.Content.Value<bool>("show");
            
            if (!string.IsNullOrEmpty(nameItem) && !string.IsNullOrEmpty(idItem))
            {
                menuLandingData.Add(new
                {
                    name = nameItem,
                    id = idItem,
                    show = show
                });
            }
        }
    }
}

<!-- ====== MENU (primer) ====== -->
<div class='menu site-header'>
    <div class='navbar header-container'>
        <nav class='nav'>
            <!-- Логотип -->
            <a href='#' class='brandnav logo-link' aria-label='На главную'>
                @if (logo != null)
                {
                    <img src='@logo.Url()' alt='@Model.Name' class='logo-image'>
                }
                else
                {
                    <span class='logo-text'>LOGO</span>
                }
            </a>

            <!-- Основное меню -->
            @if (hasMenu && filteredMenuItems != null)
            {
                <ul class='navigation site-menu'>
                    @foreach (var item in filteredMenuItems)
                    {
                        <li class='menu-item'>
                            <a href='@item.Url()' class='menu-link@(item.Url() == Model.Url() ? " active_menu" : "")'>@item.Name</a>
                        </li>
                    }
                </ul>
            }
            else if (hasMenuLanding)
            {
                <ul class='navigation landing-menu'>
                    @if (menuLandingItems != null)
                    {
                        @foreach (var blockItem in menuLandingItems)
                        {
                            var nameItem = blockItem.Content.Value<string>("nameItem");
                            var idItem = blockItem.Content.Value<string>("idItem");
                            var show = blockItem.Content.Value<bool>("show");

                            // Пропускаем пункт "Home" в меню лендинга
                            var isHomeItem = nameItem?.Equals("Home", StringComparison.OrdinalIgnoreCase) == true ||
                                            nameItem?.Equals("Главная", StringComparison.OrdinalIgnoreCase) == true ||
                                            idItem?.Equals("home", StringComparison.OrdinalIgnoreCase) == true ||
                                            idItem?.Equals("главная", StringComparison.OrdinalIgnoreCase) == true;

                            @if (!isHomeItem && show && !string.IsNullOrEmpty(nameItem) && !string.IsNullOrEmpty(idItem))
                            {
                                <li class='landing-menu-item'>
                                    <a href='#@idItem' class='landing-menu-link' data-section='@idItem'>@nameItem</a>
                                </li>
                            }
                        }
                    }
                </ul>
            }

            <!-- Дополнительные элементы -->
            @* Показываем блок, только если есть хотя бы один элемент *@
            @if (showTel || showLk || showLanguage || !string.IsNullOrEmpty(buttonName))
            {
                <div class='header-actions'>
                    @if (showTel)
                    {
                        <div class='header-phone'>
                            <span class='material-symbols-outlined phone-icon'>call</span>
                            <span class='phone-text'>Контакты</span>
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(buttonName))
                    {
                        <button class='header-button' type='button'>@buttonName</button>
                    }

                    @if (showLk)
                    {
                        <a href='/account' class='lk-link'>
                            <span class='material-symbols-outlined'>person</span>
                            <span class='lk-text'>Войти</span>
                        </a>
                    }

                    @if (showLanguage)
                    {
                        <div class='language-selector'>
                            <span class='current-language'>RU</span>
                            <span class='material-symbols-outlined'>arrow_drop_down</span>
                        </div>
                    }

                    <!-- Мобильное меню (кнопка) — оставляем JS-хук .mobile-menu-toggle -->
                    <button class='mobile-menu mobile-menu-toggle' type='button' aria-label='Меню'>
                        <span></span>
                        <span></span>
                        <span></span>
                        <span></span>
                    </button>
                </div>
            }
        </nav>
    </div>
</div>

<!-- Мобильное меню (оверлей) — оставляем JS-хуки .mobile-menu-overlay/.mobile-menu-close -->
<div class='mobile-menu-overlay'>
    <div class='mobile-menu-container'>
        <button class='mobile-menu-close' type='button' aria-label='Закрыть меню'>×</button>

        @if (hasMenu && filteredMenuItems != null)
        {
            <ul class='navigation mobile-site-menu'>
                @foreach (var item in filteredMenuItems)
                {
                    <li class='mobile-menu-item'>
                        <a href='@item.Url()' class='mobile-menu-link@(item.Url() == Model.Url() ? " active_menu" : "")'>@item.Name</a>
                    </li>
                }
            </ul>
        }
        else if (hasMenuLanding && menuLandingItems != null)
        {
            <ul class='navigation mobile-landing-menu'>
                @foreach (var blockItem in menuLandingItems)
                {
                    var nameItem = blockItem.Content.Value<string>("nameItem");
                    var idItem = blockItem.Content.Value<string>("idItem");
                    var show = blockItem.Content.Value<bool>("show");

                    // Пропускаем пункт "Home" в мобильном меню лендинга
                    var isHomeItem = nameItem?.Equals("Home", StringComparison.OrdinalIgnoreCase) == true ||
                                    nameItem?.Equals("Главная", StringComparison.OrdinalIgnoreCase) == true ||
                                    idItem?.Equals("home", StringComparison.OrdinalIgnoreCase) == true ||
                                    idItem?.Equals("главная", StringComparison.OrdinalIgnoreCase) == true;

                    @if (!isHomeItem && show && !string.IsNullOrEmpty(nameItem) && !string.IsNullOrEmpty(idItem))
                    {
                        <li class='mobile-landing-item'>
                            <a href='#@idItem' class='mobile-landing-link'>@nameItem</a>
                        </li>
                    }
                }
            </ul>
        }

        <div class='mobile-actions'>
            @if (showTel)
            {
                <a href='tel:' class='mobile-phone'>
                    <span class='material-symbols-outlined'>call</span>
                    Позвонить
                </a>
            }

            @if (showLk)
            {
                <a href='/account' class='mobile-lk'>
                    <span class='material-symbols-outlined'>person</span>
                    Личный кабинет
                </a>
            }
        </div>
    </div>
</div>

<!-- Данные для JavaScript -->
@if (hasMenuLanding)
{
    <script type="application/json" id="menu-landing-data">
        @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(menuLandingData))
    </script>
}