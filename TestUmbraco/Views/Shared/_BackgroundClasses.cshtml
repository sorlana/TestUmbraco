@using TestUmbraco.Models
@using TestUmbraco.Services
@model BackgroundClassesModel
@inject IUmbracoBackgroundService BackgroundService
@inject ILoggingService LoggingService

@{
    var hasSettings = Model.Settings != null;
    var hasComponentId = Model.ComponentId.HasValue;
    var prefix = Model.Prefix ?? "bg";
    
    // Получаем фоновые классы из сервиса
    var backgroundResult = await BackgroundService.ProcessBackground(
        Model.Settings, 
        Model.ComponentId ?? Guid.Empty,
        prefix);
    
    var backgroundClass = backgroundResult?.CssClass ?? "";
    
    // Собираем все классы
    var allClasses = new List<string>();
    
    // Базовый класс компонента
    if (!string.IsNullOrWhiteSpace(Model.BaseClass))
    {
        allClasses.Add(Model.BaseClass.Trim());
    }
    
    // Фоновые классы
    if (!string.IsNullOrWhiteSpace(backgroundClass))
    {
        allClasses.Add(backgroundClass.Trim());
    }
    
    // Дополнительные классы
    if (!string.IsNullOrWhiteSpace(Model.AdditionalClasses))
    {
        allClasses.Add(Model.AdditionalClasses.Trim());
    }
    
    var finalClass = string.Join(" ", allClasses);
    
    var containerClass = Model.ContainerClass?.Trim() ?? "";
    var overlayClass = Model.ComponentId.HasValue ? $"overlay-{Model.ComponentId.Value:N}" : "";
    var hasOverlay = backgroundResult?.HasOverlay ?? false;
    
    // Определяем тег обертки
    var wrapperTag = !string.IsNullOrWhiteSpace(Model.Tag) ? Model.Tag : "div";
    
    // Получаем ID элемента, если указан
    var elementId = !string.IsNullOrWhiteSpace(Model.ElementId) ? Model.ElementId.Trim() : "";
}

@if (!string.IsNullOrWhiteSpace(elementId))
{
    @Html.Raw($"<{wrapperTag} id=\"{elementId}\" class=\"{finalClass}\">")
}
else
{
    @Html.Raw($"<{wrapperTag} class=\"{finalClass}\">")
}

@if (backgroundResult?.Type == BackgroundType.Video && !string.IsNullOrEmpty(backgroundResult.VideoId))
{
    <div class="video-container">
        @* Видео для десктопа *@
        <iframe class="video-bg-iframe" 
                src="https://player.vimeo.com/video/@backgroundResult.VideoId?background=1&autoplay=1&loop=1&byline=0&title=0&muted=1" 
                frameborder="0" 
                allow="autoplay; fullscreen" 
                allowfullscreen>
        </iframe>
        
        @* Placeholder для мобильных устройств *@
        @if (backgroundResult.UseVideoPlaceholder && !string.IsNullOrEmpty(backgroundResult.VideoPlaceholder))
        {
            <div class="video-placeholder-mobile" 
                 style="background-image: url('@backgroundResult.VideoPlaceholder');">
            </div>
        }
    </div>
}

@if (!string.IsNullOrWhiteSpace(containerClass))
{
    <div class="@containerClass">
        @Model.Content?.Invoke(Model)
    </div>
}
else
{
    @Model.Content?.Invoke(Model)
}

@Html.Raw($"</{wrapperTag}>")