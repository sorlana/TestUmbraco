@using TestUmbraco.Models
@using TestUmbraco.Services
@model BackgroundClassesModel
@inject IUmbracoBackgroundService BackgroundService
@inject ILoggingService LoggingService

@{
    var hasSettings = Model.Settings != null;
    var hasComponentId = Model.ComponentId.HasValue;
    var prefix = Model.Prefix ?? "bg";
    
    // Получаем фоновые классы из сервиса
    var backgroundResult = await BackgroundService.ProcessBackground(
        Model.Settings, 
        Model.ComponentId ?? Guid.Empty,
        prefix);
    
    var backgroundClass = backgroundResult?.CssClass ?? "";
    
    // Собираем все классы
    var allClasses = new List<string>();
    
    // Базовый класс компонента
    if (!string.IsNullOrWhiteSpace(Model.BaseClass))
    {
        allClasses.Add(Model.BaseClass.Trim());
    }
    
    // Фоновые классы
    if (!string.IsNullOrWhiteSpace(backgroundClass))
    {
        allClasses.Add(backgroundClass.Trim());
    }
    
    // Дополнительные классы
    if (!string.IsNullOrWhiteSpace(Model.AdditionalClasses))
    {
        allClasses.Add(Model.AdditionalClasses.Trim());
    }
    
    var finalClass = string.Join(" ", allClasses);
    
    var containerClass = Model.ContainerClass?.Trim() ?? "";
    var overlayClass = Model.ComponentId.HasValue ? $"overlay-{Model.ComponentId.Value:N}" : "";
    var hasOverlay = backgroundResult?.HasOverlay ?? false;
    
    // Определяем тег обертки
    var wrapperTag = !string.IsNullOrWhiteSpace(Model.Tag) ? Model.Tag : "div";
    
    // Получаем ID элемента, если указан
    var elementId = !string.IsNullOrWhiteSpace(Model.ElementId) ? Model.ElementId.Trim() : "";
}

@if (!string.IsNullOrWhiteSpace(elementId))
{
    @Html.Raw($"<{wrapperTag} id=\"{elementId}\" class=\"{finalClass}\">")
}
else
{
    @Html.Raw($"<{wrapperTag} class=\"{finalClass}\">")
}

@if (backgroundResult?.Type == BackgroundType.Video && !string.IsNullOrEmpty(backgroundResult.VideoId))
{
    var videoId = Guid.NewGuid().ToString("N");
    <div class="video-container" data-video-container="@videoId">
        @* Единый placeholder для десктопа и мобильных *@
        @if (backgroundResult.UseVideoPlaceholder && !string.IsNullOrEmpty(backgroundResult.VideoPlaceholder))
        {
            <div class="video-placeholder" 
                 data-video-placeholder="@videoId"
                 data-bg-image="@backgroundResult.VideoPlaceholder">
            </div>
        }
        
        @* Видео для десктопа с lazy loading *@
        <iframe class="video-bg-iframe" 
                data-video-iframe="@videoId"
                data-src="https://player.vimeo.com/video/@backgroundResult.VideoId?background=1&autoplay=1&loop=1&byline=0&title=0&muted=1"
                frameborder="0" 
                allow="autoplay; fullscreen" 
                allowfullscreen>
        </iframe>
    </div>
    
    @* JavaScript для lazy loading видео *@
    <script>
        (function() {
            var videoId = '@videoId';
            var container = document.querySelector('[data-video-container="' + videoId + '"]');
            if (!container) return;
            
            var iframe = container.querySelector('[data-video-iframe="' + videoId + '"]');
            var placeholder = container.querySelector('[data-video-placeholder="' + videoId + '"]');
            
            if (!iframe) return;
            
            // Устанавливаем background-image для placeholder из data-атрибута
            if (placeholder) {
                var bgImage = placeholder.getAttribute('data-bg-image');
                if (bgImage) {
                    placeholder.style.backgroundImage = 'url(' + bgImage + ')';
                }
                placeholder.classList.add('video-placeholder-active');
            }
            
            // Проверяем, находимся ли мы в iframe (backoffice)
            var isInIframe = window.self !== window.top;
            
            if (isInIframe) {
                // В backoffice НЕ загружаем видео, показываем только placeholder
                iframe.classList.add('video-hidden');
                if (placeholder) {
                    placeholder.classList.add('video-placeholder-visible');
                }
                return;
            }
            
            // На фронтенде загружаем видео
            function loadVideo() {
                var dataSrc = iframe.getAttribute('data-src');
                console.log('[Video Debug] Loading video:', videoId, 'src:', dataSrc);
                iframe.src = dataSrc;
                
                // Проверяем видимость iframe
                var iframeStyles = window.getComputedStyle(iframe);
                console.log('[Video Debug] Iframe styles:', {
                    display: iframeStyles.display,
                    zIndex: iframeStyles.zIndex,
                    opacity: iframeStyles.opacity,
                    visibility: iframeStyles.visibility
                });
                
                if (placeholder) {
                    // Слушаем сообщения от Vimeo Player API
                    var messageHandler = function(event) {
                        if (event.origin !== 'https://player.vimeo.com') return;
                        
                        try {
                            var data = JSON.parse(event.data);
                            console.log('[Video Debug] Vimeo event:', data.event);
                            // Скрываем placeholder когда видео начало воспроизводиться
                            if (data.event === 'ready' || data.event === 'play' || data.event === 'playProgress') {
                                console.log('[Video Debug] Hiding placeholder after event:', data.event);
                                setTimeout(function() {
                                    placeholder.classList.add('video-placeholder-hidden');
                                    window.removeEventListener('message', messageHandler);
                                }, 1000);
                            }
                        } catch (e) {
                            // Игнорируем ошибки парсинга
                        }
                    };
                    
                    window.addEventListener('message', messageHandler);
                    
                    // Fallback: скрываем через 5 секунд если не получили событие от Vimeo
                    setTimeout(function() {
                        console.log('[Video Debug] Fallback: hiding placeholder after 5s');
                        placeholder.classList.add('video-placeholder-hidden');
                        window.removeEventListener('message', messageHandler);
                    }, 5000);
                }
            }
            
            // Используем IntersectionObserver для lazy loading
            if ('IntersectionObserver' in window) {
                var observer = new IntersectionObserver(function(entries) {
                    entries.forEach(function(entry) {
                        if (entry.isIntersecting) {
                            loadVideo();
                            observer.unobserve(container);
                        }
                    });
                }, { 
                    rootMargin: '200px',
                    threshold: 0.01 
                });
                
                observer.observe(container);
            } else {
                loadVideo();
            }
        })();
    </script>
}

@if (!string.IsNullOrWhiteSpace(containerClass))
{
    <div class="@containerClass">
        @Model.Content?.Invoke(Model)
    </div>
}
else
{
    @Model.Content?.Invoke(Model)
}

@Html.Raw($"</{wrapperTag}>")