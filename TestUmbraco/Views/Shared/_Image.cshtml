@using Umbraco.Cms.Core.Models.PublishedContent
@using TestUmbraco.Helpers
@inject ImageHelper ImageHelper

@model IPublishedContent?

@{
    var cssClass = ViewData["CssClass"] as string ?? "";
    var cropAlias = ViewData["CropAlias"] as string;
    var altText = ViewData["AltText"] as string ?? Model?.Name ?? "";
    var lazyLoad = ViewData["LazyLoad"] as bool? ?? true;
    var attributes = ViewData["Attributes"] as Dictionary<string, string>;
    
    // Уберите этот параметр - он не нужен
    // var skipWrapper = ViewData["SkipWrapper"] as bool? ?? false;
    
    // Просто всегда передаем skipWrapper: false в ImageHelper
    // но НЕ создаем свою обертку
}

@if (Model != null)
{
    try
    {
        if (ImageHelper != null)
        {
            // Используем skipWrapper: false, чтобы ImageHelper сам создал обертку
            var imageHtml = await ImageHelper.RenderResponsiveMediaAsync(
                media: Model,
                cropAlias: cropAlias,
                cssClass: cssClass,
                altText: altText,
                lazyLoad: lazyLoad,
                attributes: attributes,
                responsiveWidths: null,
                sizes: null,
                gridColumns: "col-12",
                includeWebp: true,
                skipWrapper: false  // Пусть ImageHelper создает обертку
            );
            
            if (imageHtml != null && !string.IsNullOrEmpty(imageHtml.ToString()))
            {
                @imageHtml
            }
            else
            {
                <img src="@Model.Url()" 
                     alt="@altText"
                     class="image-fallback @cssClass"
                     loading="lazy"
                     decoding="async" />
            }
        }
        else
        {
            <img src="@Model.Url()" 
                 alt="@altText"
                 class="image-fallback @cssClass"
                 loading="lazy"
                 decoding="async" />
        }
    }
    catch (Exception)
    {
        <img src="@Model.Url()" 
             alt="@altText"
             class="image-error @cssClass"
             loading="lazy"
             decoding="async" />
    }
}
else
{
    <!-- Если изображение отсутствует -->
    <div class="image-placeholder @cssClass">
        <div class="placeholder-content">
            <svg class="placeholder-icon" width="40" height="40" viewBox="0 0 24 24">
                <path fill="#adb5bd" d="M21,3H3C1.9,3,1,3.9,1,5v14c0,1.1,0.9,2,2,2h18c1.1,0,2-0.9,2-2V5C23,3.9,22.1,3,21,3z M21,19H3V5h18V19z"/>
                <circle fill="#adb5bd" cx="9" cy="10" r="3"/>
                <path fill="#adb5bd" d="M19,7h-6v6h6V7z"/>
            </svg>
            <span class="placeholder-text">Нет изображения</span>
        </div>
    </div>
}